#!/usr/bin/env bash
set -euo pipefail

_RAVEN_PROG="ravenslide"

# Source shared library (look next to this script, then in PATH)
_LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$_LIB_DIR/ravenslide-lib" ]]; then
  # shellcheck source=ravenslide-lib
  source "$_LIB_DIR/ravenslide-lib"
else
  # shellcheck source=ravenslide-lib
  source ravenslide-lib 2>/dev/null || { echo "ravenslide: cannot find ravenslide-lib" >&2; exit 1; }
fi

# ---------------------------------------------------------------------------
# Query helpers
# ---------------------------------------------------------------------------

active_workspace_id() {
  hypr_json activeworkspace | jq -r '.id'
}

active_window_addr() {
  hypr_json activewindow | jq -r '.address // empty'
}

active_window_is_fullscreen() {
  hypr_json activewindow | jq -r '.fullscreen // false'
}

occupied_panel_ids() {
  hypr_json workspaces \
    | jq -r --argjson s "$RAVEN_SLIDE_START" --argjson e "$RAVEN_SLIDE_END" '
      .[]
      | select(.id >= $s and .id <= $e and .windows > 0)
      | .id
    ' \
    | sort -n
}

next_free_panel_id() {
  local used
  used="$(occupied_panel_ids)"

  local id
  for ((id = RAVEN_SLIDE_START; id <= RAVEN_SLIDE_END; id++)); do
    if ! grep -qx "$id" <<<"$used"; then
      echo "$id"
      return 0
    fi
  done

  return 1
}

# ---------------------------------------------------------------------------
# Action helpers
# ---------------------------------------------------------------------------

switch_workspace() {
  local ws="$1"
  "$HYPRCTL_BIN" dispatch workspace "$ws" >/dev/null
}

move_active_to_workspace() {
  local ws="$1"
  "$HYPRCTL_BIN" dispatch movetoworkspacesilent "$ws" >/dev/null
}

ensure_active_fullscreen() {
  hypr_json_flush
  local is_fs
  is_fs="$(active_window_is_fullscreen)"
  if [[ "$is_fs" != "true" && "$is_fs" != "1" ]]; then
    "$HYPRCTL_BIN" dispatch fullscreen "$RAVEN_SLIDE_FULLSCREEN_MODE" >/dev/null
  fi
}

# ---------------------------------------------------------------------------
# Commands
# ---------------------------------------------------------------------------

cmd_new() {
  local ws
  ws="$(next_free_panel_id)" || die "no free panel workspace left in ${RAVEN_SLIDE_START}-${RAVEN_SLIDE_END}"
  switch_workspace "$ws"
  echo "workspace:$ws"
}

cmd_adopt() {
  local addr
  addr="$(active_window_addr)"
  [[ -n "$addr" && "$addr" != "null" ]] || die "no active window"

  local ws
  ws="$(next_free_panel_id)" || die "no free panel workspace left in ${RAVEN_SLIDE_START}-${RAVEN_SLIDE_END}"

  move_active_to_workspace "$ws"
  switch_workspace "$ws"
  ensure_active_fullscreen
  echo "moved:$addr workspace:$ws"
}

cmd_launch() {
  (( $# > 0 )) || die "launch requires a command, e.g. ravenslide launch kitty"
  local ws
  ws="$(next_free_panel_id)" || die "no free panel workspace left in ${RAVEN_SLIDE_START}-${RAVEN_SLIDE_END}"
  switch_workspace "$ws"
  "$@" >/dev/null 2>&1 &
  disown || true

  # Poll for the new window to appear, then fullscreen it
  local waited=0
  while (( waited < 50 )); do
    sleep 0.1
    hypr_json_flush
    local win_addr
    win_addr="$(active_window_addr)" || true
    if [[ -n "$win_addr" && "$win_addr" != "null" ]]; then
      ensure_active_fullscreen
      echo "launched workspace:$ws cmd:$*"
      return 0
    fi
    (( waited++ ))
  done

  # Window didn't appear in time, still report success for the launch itself
  echo "launched workspace:$ws cmd:$* (window not yet detected)"
}

cmd_close() {
  local current
  current="$(active_workspace_id)"

  # Only act if we're on a panel workspace
  if (( current < RAVEN_SLIDE_START || current > RAVEN_SLIDE_END )); then
    die "not on a panel workspace (current: $current)"
  fi

  # Close the active window
  local addr
  addr="$(active_window_addr)"
  if [[ -n "$addr" && "$addr" != "null" ]]; then
    "$HYPRCTL_BIN" dispatch closewindow "address:$addr" >/dev/null
  fi

  # Brief pause for Hyprland to process the close
  sleep 0.1
  hypr_json_flush

  # Navigate to nearest occupied panel
  mapfile -t ids < <(occupied_panel_ids)
  if (( ${#ids[@]} == 0 )); then
    echo "closed:$current (no panels remaining)"
    return 0
  fi

  # Find nearest panel
  local best="${ids[0]}"
  local best_dist=$(( current - ids[0] ))
  (( best_dist < 0 )) && best_dist=$(( -best_dist ))

  local id dist
  for id in "${ids[@]}"; do
    dist=$(( current - id ))
    (( dist < 0 )) && dist=$(( -dist ))
    if (( dist < best_dist )); then
      best="$id"
      best_dist="$dist"
    fi
  done

  switch_workspace "$best"
  echo "closed:$current -> workspace:$best"
}

cmd_goto() {
  (( $# > 0 )) || die "goto requires a workspace ID, e.g. ravenslide goto 23"
  local target="$1"
  validate_int "workspace ID" "$target"
  if (( target < RAVEN_SLIDE_START || target > RAVEN_SLIDE_END )); then
    die "workspace $target is outside panel range ${RAVEN_SLIDE_START}-${RAVEN_SLIDE_END}"
  fi
  switch_workspace "$target"
  echo "workspace:$target"
}

cmd_swap() {
  local direction="${1:-}"
  [[ "$direction" == "next" || "$direction" == "prev" ]] || die "swap requires 'next' or 'prev'"

  local current
  current="$(active_workspace_id)"
  if (( current < RAVEN_SLIDE_START || current > RAVEN_SLIDE_END )); then
    die "not on a panel workspace (current: $current)"
  fi

  mapfile -t ids < <(occupied_panel_ids)
  (( ${#ids[@]} > 1 )) || die "need at least 2 occupied panels to swap"

  # Find current position
  local idx=-1 i
  for i in "${!ids[@]}"; do
    if [[ "${ids[$i]}" == "$current" ]]; then
      idx="$i"
      break
    fi
  done
  (( idx != -1 )) || die "current workspace $current not in occupied panel list"

  # Determine target
  local target_idx
  if [[ "$direction" == "next" ]]; then
    target_idx=$(( (idx + 1) % ${#ids[@]} ))
  else
    target_idx=$(( (idx - 1 + ${#ids[@]}) % ${#ids[@]} ))
  fi
  local target_ws="${ids[$target_idx]}"

  # Get window addresses on each workspace
  local current_addr target_addr
  current_addr="$(hypr_json clients | jq -r --argjson ws "$current" '
    [.[] | select(.workspace.id == $ws)][0].address // empty
  ')"
  target_addr="$(hypr_json clients | jq -r --argjson ws "$target_ws" '
    [.[] | select(.workspace.id == $ws)][0].address // empty
  ')"

  [[ -n "$current_addr" ]] || die "no window on current panel $current"
  [[ -n "$target_addr" ]] || die "no window on target panel $target_ws"

  # Batch swap: move both windows simultaneously
  "$HYPRCTL_BIN" --batch "
    dispatch movetoworkspacesilent $target_ws,address:$current_addr;
    dispatch movetoworkspacesilent $current,address:$target_addr
  " >/dev/null

  echo "swapped:$current<->$target_ws"
}

cmd_cycle() {
  local direction="$1"
  mapfile -t ids < <(occupied_panel_ids)
  (( ${#ids[@]} > 0 )) || die "no occupied panel workspaces in ${RAVEN_SLIDE_START}-${RAVEN_SLIDE_END}"

  local current
  current="$(active_workspace_id)"

  local idx=-1
  local i
  for i in "${!ids[@]}"; do
    if [[ "${ids[$i]}" == "$current" ]]; then
      idx="$i"
      break
    fi
  done

  local target
  if (( idx == -1 )); then
    if [[ "$direction" == "next" ]]; then
      target="${ids[0]}"
    else
      target="${ids[${#ids[@]}-1]}"
    fi
  else
    if [[ "$direction" == "next" ]]; then
      target="${ids[$(((idx + 1) % ${#ids[@]}))]}"
    else
      target="${ids[$(((idx - 1 + ${#ids[@]}) % ${#ids[@]}))]}"
    fi
  fi

  switch_workspace "$target"
  echo "workspace:$target"
}

cmd_list() {
  local current
  current="$(active_workspace_id)"

  # Header
  printf '%-4s  %-6s  %-40s\n' "ID" "WINS" "TITLE"
  printf '%-4s  %-6s  %-40s\n' "----" "------" "----------------------------------------"

  hypr_json workspaces \
    | jq -r --argjson s "$RAVEN_SLIDE_START" --argjson e "$RAVEN_SLIDE_END" --argjson c "$current" '
      .[]
      | select(.id >= $s and .id <= $e and .windows > 0)
      | [.id, .windows, (.lastwindowtitle // "-"), (if .id == $c then "*" else "" end)]
      | @tsv
    ' \
    | sort -n \
    | while IFS=$'\t' read -r id wins title marker; do
        if [[ -n "$marker" ]]; then
          printf '%-4s  %-6s  %-40s %s\n' "$id" "$wins" "$title" "$marker"
        else
          printf '%-4s  %-6s  %-40s\n' "$id" "$wins" "$title"
        fi
      done
}

# ---------------------------------------------------------------------------
# Help & main
# ---------------------------------------------------------------------------

print_help() {
  cat <<EOF
ravenslide: workspace-panel helper for Hyprland

Usage:
  ravenslide new              Switch to the next empty panel workspace
  ravenslide adopt            Move active window to next empty panel + fullscreen it
  ravenslide launch <cmd...>  Switch to next empty panel and launch a command there
  ravenslide next             Slide to next occupied panel workspace
  ravenslide prev             Slide to previous occupied panel workspace
  ravenslide close            Close current panel window, slide to nearest panel
  ravenslide goto <id>        Jump directly to a panel workspace by ID
  ravenslide swap next|prev   Swap current panel's window with adjacent panel
  ravenslide list             List occupied panel workspaces
  ravenslide help             Show this help

Environment:
  RAVEN_SLIDE_START (default: 21)
  RAVEN_SLIDE_END   (default: 40)
  RAVEN_SLIDE_FULLSCREEN_MODE (default: 1)
  HYPRCTL_BIN (default: hyprctl)
EOF
}

main() {
  local cmd="${1:-help}"
  shift || true

  if [[ "$cmd" == "help" || "$cmd" == "-h" || "$cmd" == "--help" ]]; then
    print_help
    return 0
  fi

  need_cmd "$HYPRCTL_BIN"
  need_cmd jq
  validate_range

  case "$cmd" in
    new)
      cmd_new
      ;;
    adopt)
      cmd_adopt
      ;;
    launch)
      cmd_launch "$@"
      ;;
    next)
      cmd_cycle next
      ;;
    prev)
      cmd_cycle prev
      ;;
    close)
      cmd_close
      ;;
    goto)
      cmd_goto "$@"
      ;;
    swap)
      cmd_swap "$@"
      ;;
    list)
      cmd_list
      ;;
    *)
      die "unknown command: $cmd (try: ravenslide help)"
      ;;
  esac
}

main "$@"
